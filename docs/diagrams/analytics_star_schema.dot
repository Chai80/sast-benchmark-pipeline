
digraph StarSchema {
  graph [
    rankdir=LR,
    splines=ortho,
    nodesep=0.70,
    ranksep=1.20,
    fontname="Helvetica",
    fontsize=18,
    labelloc="t",
    label="Analytics Star Schema (Suite Runs)\nPurpose: A/B testing + dashboards over deterministic suite artifacts",
    bgcolor="white",
    concentrate=false
  ];

  node [
    shape=plain,
    fontname="Helvetica",
    fontsize=10
  ];

  edge [
    fontname="Helvetica",
    fontsize=9,
    color="#444444",
    arrowsize=0.8,
    penwidth=1.1
  ];

  // =========================
  // Dimensions (left)
  // =========================
  dim_suite_run [label=<
    <TABLE BORDER="0" CELLBORDER="1" CELLSPACING="0" CELLPADDING="8">
      <TR><TD BGCOLOR="#D9E1F2"><B>dim_suite_run</B></TD></TR>
      <TR><TD ALIGN="LEFT"><B>PK:</B> suite_run_id<br ALIGN="LEFT"/>
        <B>Purpose:</B> run metadata<br ALIGN="LEFT"/>
        • run_ts_utc, pipeline_git_sha<br ALIGN="LEFT"/>
        • toolset_signature, calibration_id
      </TD></TR>
    </TABLE>
  >];

  dim_case [label=<
    <TABLE BORDER="0" CELLBORDER="1" CELLSPACING="0" CELLPADDING="8">
      <TR><TD BGCOLOR="#D9E1F2"><B>dim_case</B></TD></TR>
      <TR><TD ALIGN="LEFT"><B>PK:</B> (benchmark_id, case_id)<br ALIGN="LEFT"/>
        <B>Purpose:</B> static case metadata<br ALIGN="LEFT"/>
        • owasp_id (A01–A10), track<br ALIGN="LEFT"/>
        • gt_total, language, tags
      </TD></TR>
    </TABLE>
  >];

  // =========================
  // Core facts (middle + right)
  // =========================
  fact_eval_case_k [label=<
    <TABLE BORDER="0" CELLBORDER="1" CELLSPACING="0" CELLPADDING="8">
      <TR><TD BGCOLOR="#FFF2CC"><B>fact_eval_case_k</B></TD></TR>
      <TR><TD ALIGN="LEFT"><B>PK:</B> (suite_run_id, case_id, strategy, k)<br ALIGN="LEFT"/>
        <B>Purpose:</B> case-level A/B metrics<br ALIGN="LEFT"/>
        • precision_at_k, coverage_at_k<br ALIGN="LEFT"/>
        • paired deltas by case (A/B)
      </TD></TR>
    </TABLE>
  >];

  fact_eval_suite_k [label=<
    <TABLE BORDER="0" CELLBORDER="1" CELLSPACING="0" CELLPADDING="8">
      <TR><TD BGCOLOR="#FFF2CC"><B>fact_eval_suite_k</B></TD></TR>
      <TR><TD ALIGN="LEFT"><B>PK:</B> (suite_run_id, strategy, k, agg_type)<br ALIGN="LEFT"/>
        <B>Purpose:</B> headline KPIs for dashboards<br ALIGN="LEFT"/>
        • macro/micro precision@k, coverage@k
      </TD></TR>
    </TABLE>
  >];

  fact_tool_value [label=<
    <TABLE BORDER="0" CELLBORDER="1" CELLSPACING="0" CELLPADDING="8">
      <TR><TD BGCOLOR="#FFF2CC"><B>fact_tool_value</B></TD></TR>
      <TR><TD ALIGN="LEFT"><B>PK:</B> (suite_run_id, tool, metric_name)<br ALIGN="LEFT"/>
        <B>Purpose:</B> tool contribution<br ALIGN="LEFT"/>
        • metric_name ∈ {utility, marginal}<br ALIGN="LEFT"/>
        • metric_value
      </TD></TR>
    </TABLE>
  >];

  // =========================
  // Tool provenance (dimension-like, but may include measures)
  // =========================
  dim_tool_run [label=<
    <TABLE BORDER="0" CELLBORDER="1" CELLSPACING="0" CELLPADDING="8">
      <TR><TD BGCOLOR="#D9E1F2"><B>dim_tool_run</B></TD></TR>
      <TR><TD ALIGN="LEFT"><B>PK:</B> (suite_run_id, case_id, tool, run_id)<br ALIGN="LEFT"/>
        <B>Purpose:</B> provenance &amp; performance<br ALIGN="LEFT"/>
        • tool_version, ruleset_hash<br ALIGN="LEFT"/>
        • runtime_seconds, findings counts
      </TD></TR>
    </TABLE>
  >];

  // =========================
  // Layout columns (ranks)
  // =========================
  { rank=same; dim_suite_run; dim_case; }
  { rank=same; fact_eval_case_k; dim_tool_run; }
  { rank=same; fact_eval_suite_k; fact_tool_value; }

  // Encourage vertical ordering to reduce crossings
  dim_suite_run -> dim_case [style=invis, weight=10];
  fact_eval_case_k -> dim_tool_run [style=invis, weight=10];
  fact_eval_suite_k -> fact_tool_value [style=invis, weight=10];

  // =========================
  // Relationships (left -> right)
  // =========================
  // Run joins
  dim_suite_run -> fact_eval_case_k  [tailport=e, headport=w];
  dim_suite_run -> dim_tool_run     [tailport=e, headport=w];
  dim_suite_run -> fact_eval_suite_k[tailport=e, headport=w];
  dim_suite_run -> fact_tool_value  [tailport=e, headport=w];

  // Case joins
  dim_case      -> fact_eval_case_k [tailport=e, headport=w];
  dim_case      -> dim_tool_run     [tailport=e, headport=w];

  // =========================
  // Legend
  // =========================
  legend [label=<
    <TABLE BORDER="0" CELLBORDER="1" CELLSPACING="0" CELLPADDING="6">
      <TR><TD COLSPAN="2"><B>Legend</B></TD></TR>
      <TR><TD BGCOLOR="#D9E1F2">Dimension</TD><TD ALIGN="LEFT">Descriptive attributes used for slicing &amp; joins</TD></TR>
      <TR><TD BGCOLOR="#FFF2CC">Fact</TD><TD ALIGN="LEFT">Measurable outcomes used for metrics, A/B, dashboards</TD></TR>
      <TR><TD ALIGN="LEFT" COLSPAN="2"><FONT POINT-SIZE="9">Join keys are listed inside each table.</FONT></TD></TR>
    </TABLE>
  >];

  { rank=sink; legend; }
}
