stateDiagram-v2
  %% Durinn SAST Benchmark Pipeline — Runtime State Machine (high level)
  %% This focuses on control-flow states (not ownership boundaries).

  [*] --> ParseArgs
  ParseArgs --> BuildPipeline
  BuildPipeline --> DispatchMode

  DispatchMode --> RunSingleCase: mode=scan
  DispatchMode --> RunSingleCase: mode=benchmark
  DispatchMode --> ResolveSuite: mode=suite
  DispatchMode --> RunAnalyze: mode=analyze

  state RunSingleCase {
    [*] --> BuildRunRequest
    BuildRunRequest --> EnsureBundle
    EnsureBundle --> ToolLoop

    note right of EnsureBundle
      When use_suite=true:
        - ensure suite/case dirs
        - write runs/suites/LATEST
        - update suite.json + case.json + summary.csv
      When use_suite=false:
        - tools write to legacy runs/{tool}/{repo}/{run_id}/...
    end note

    state ToolLoop {
      [*] --> BuildCmd
      BuildCmd --> ExecuteTool
      ExecuteTool --> WriteArtifacts
      WriteArtifacts --> NextTool
      NextTool --> BuildCmd: more tools
      NextTool --> [*]: done
    }

    note right of WriteArtifacts
      Tool-run artifacts:
        - raw.* (scanner specific)
        - normalized.json
        - metadata.json
        - run.json
        - logs/
    end note

    ToolLoop --> OptionalAnalysis
    OptionalAnalysis --> UpdateManifests
    UpdateManifests --> [*]

    note right of OptionalAnalysis
      Per-case analysis writes:
        runs/suites/{suite_id}/cases/{case_id}/analysis/*
    end note
  }

  state ResolveSuite {
    [*] --> CollectSuiteInputs
    CollectSuiteInputs --> MaybeBootstrapWorktrees
    MaybeBootstrapWorktrees --> BuildSuiteDefinition
    BuildSuiteDefinition --> WriteSuiteManifest
    WriteSuiteManifest --> [*]

    note right of MaybeBootstrapWorktrees
      Optional “bridge path” for branch-per-case suites:
        - inputs: repo_url + branch tokens (e.g., A03,A07 or A01-A10)
        - action: materialize worktrees under repos/worktrees/<repo_id>/...
        - then continue as a normal --worktrees-root suite
    end note

    note right of WriteSuiteManifest
      Suite scaffolding:
        - runs/suites/{suite_id}/suite.json
        - runs/suites/{suite_id}/README.txt
        - runs/suites/{suite_id}/summary.csv
        - runs/suites/LATEST
    end note
  }

  ResolveSuite --> RunSuiteCases

  state RunSuiteCases {
    [*] --> CaseLoop
    CaseLoop --> RunSingleCase: next case
    RunSingleCase --> CaseLoop: until exhausted
    CaseLoop --> [*]
  }

  RunSuiteCases --> MaybeQACalibration

  state MaybeQACalibration {
    [*] --> Decide
    Decide --> [*]: qa-calibration disabled
    Decide --> QARunbook: --qa-calibration
  }

  state QARunbook {
    [*] --> BuildSuiteDataset
    BuildSuiteDataset --> BuildCalibration
    BuildCalibration --> BuildEval
    BuildEval --> MaybeReanalyze
    MaybeReanalyze --> ValidateArtifacts
    ValidateArtifacts --> [*]

    note right of BuildSuiteDataset
      Suite-level aggregation:
        - analysis/_tables/triage_dataset.csv
    end note

    note right of BuildCalibration
      Learn weights from GT:
        - analysis/triage_calibration.json
        - analysis/_tables/triage_calibration_report.csv
    end note

    note right of MaybeReanalyze
      Calibration is suite-scoped, so we need
      a second “analysis-only” pass for per-case
      triage_queue.csv to populate triage_score_v1.

      Skippable via --qa-no-reanalyze
      (not recommended for end-to-end QA).
    end note

    note right of ValidateArtifacts
      Deterministic PASS/FAIL checklist.
      Validates artifacts exist under runs/suites/<suite_id>/...
      (the most recent suite id is stored in the pointer file runs/suites/LATEST).
    end note
  }

  state RunAnalyze {
    [*] --> ResolveCaseDir
    ResolveCaseDir --> DiscoverRuns
    DiscoverRuns --> RunReports
    RunReports --> [*]

    note right of ResolveCaseDir
      Accepts suite_id="latest" via runs/suites/LATEST.
      Case id resolution tolerates '-' <-> '_' variants.
    end note

    note right of RunReports
      GT scoring + matching is controlled by a tolerance knob
      (CLI: --gt-tolerance). For calibration suites where GT
      markers are not on the exact sink line, a non-zero
      tolerance may be required.
    end note
  }

  RunAnalyze --> [*]
